<script>
    class SimpleBook {
        constructor() {
            this.totalPages = 100;
            this.currentPage = 1;
            
            // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
            this.writingArea = document.getElementById('writingArea');
            this.pageNumber = document.getElementById('pageNumber');
            this.pageInput = document.getElementById('pageInput');
            this.progressFill = document.getElementById('progressFill');
            
            // –ö–Ω–æ–ø–∫–∏
            this.firstBtn = document.getElementById('firstPageBtn');
            this.prevBtn = document.getElementById('prevPageBtn');
            this.nextBtn = document.getElementById('nextPageBtn');
            this.lastBtn = document.getElementById('lastPageBtn');
            this.clearBtn = document.getElementById('clearBtn');
            this.resetAllBtn = document.getElementById('resetAllBtn');
            this.pastePlainBtn = document.getElementById('pastePlainBtn');
            this.saveCloudBtn = document.getElementById('saveCloudBtn');
            this.loadCloudBtn = document.getElementById('loadCloudBtn');
            this.shareBtn = document.getElementById('shareBtn');
            
            // –•—Ä–∞–Ω–∏–ª–∏—â–µ –∑–∞–º–µ—Ç–æ–∫
            this.notes = this.loadNotes();
            
            this.init();
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑ localStorage
        loadNotes() {
            const savedNotes = localStorage.getItem('simpleBook');
            if (savedNotes) {
                try {
                    return JSON.parse(savedNotes);
                } catch (e) {
                    console.log('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏');
                }
            }
            return Array(this.totalPages).fill('');
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ localStorage
        saveNotes() {
            localStorage.setItem('simpleBook', JSON.stringify(this.notes));
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        saveCurrentPage() {
            const index = this.currentPage - 1;
            if (index >= 0 && index < this.totalPages) {
                this.notes[index] = this.writingArea.innerHTML;
                this.saveNotes();
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        loadPage() {
            const index = this.currentPage - 1;
            if (index >= 0 && index < this.totalPages) {
                this.writingArea.innerHTML = this.notes[index] || '';
            }
            
            this.pageNumber.textContent = `–°—Ç—Ä–∞–Ω–∏—Ü–∞ ${this.currentPage}`;
            this.pageInput.value = this.currentPage;
            
            if (this.currentPage === 1) {
                this.writingArea.setAttribute('placeholder', 'üìñ –ü–µ—Ä–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞...');
            } else if (this.currentPage === this.totalPages) {
                this.writingArea.setAttribute('placeholder', 'üéØ –ü–æ—Å–ª–µ–¥–Ω—è—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞...');
            } else {
                this.writingArea.setAttribute('placeholder', '‚úçÔ∏è –ü–∏—à–∏—Ç–µ...');
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
        updateProgress() {
            const nonEmptyPages = this.notes.filter(note => note && note !== '' && note !== '<br>').length;
            const progress = (nonEmptyPages / this.totalPages) * 100;
            this.progressFill.style.width = `${progress}%`;
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–Ω–æ–ø–æ–∫
        updateButtons() {
            this.firstBtn.disabled = this.currentPage === 1;
            this.prevBtn.disabled = this.currentPage === 1;
            this.nextBtn.disabled = this.currentPage === this.totalPages;
            this.lastBtn.disabled = this.currentPage === this.totalPages;
        }

        // –ù–∞–≤–∏–≥–∞—Ü–∏—è
        nextPage() {
            if (this.currentPage < this.totalPages) {
                this.saveCurrentPage();
                this.currentPage++;
                this.loadPage();
                this.updateButtons();
                this.updateProgress();
            }
        }

        prevPage() {
            if (this.currentPage > 1) {
                this.saveCurrentPage();
                this.currentPage--;
                this.loadPage();
                this.updateButtons();
                this.updateProgress();
            }
        }

        firstPage() {
            if (this.currentPage !== 1) {
                this.saveCurrentPage();
                this.currentPage = 1;
                this.loadPage();
                this.updateButtons();
                this.updateProgress();
            }
        }

        lastPage() {
            if (this.currentPage !== this.totalPages) {
                this.saveCurrentPage();
                this.currentPage = this.totalPages;
                this.loadPage();
                this.updateButtons();
                this.updateProgress();
            }
        }

        goToPage(pageNumber) {
            if (pageNumber >= 1 && pageNumber <= this.totalPages && pageNumber !== this.currentPage) {
                this.saveCurrentPage();
                this.currentPage = pageNumber;
                this.loadPage();
                this.updateButtons();
                this.updateProgress();
            }
        }

        // –û—á–∏—Å—Ç–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        clearCurrentPage() {
            if (confirm('–û—á–∏—Å—Ç–∏—Ç—å —Ç–µ–∫—É—â—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É?')) {
                this.writingArea.innerHTML = '';
                this.saveCurrentPage();
                this.updateProgress();
            }
        }

        // –°–±—Ä–æ—Å –≤—Å–µ—Ö —Å—Ç—Ä–∞–Ω–∏—Ü
        resetAllPages() {
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã? –í—Å–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –±—É–¥—É—Ç –æ—á–∏—â–µ–Ω—ã!')) {
                this.notes = Array(this.totalPages).fill('');
                this.saveNotes();
                this.loadPage();
                this.updateProgress();
            }
        }

        // –í—Å—Ç–∞–≤–∫–∞ —Ç–µ–∫—Å—Ç–∞
        async pasteAsPlainText() {
            try {
                const text = await navigator.clipboard.readText();
                this.writingArea.innerText = text;
                this.saveCurrentPage();
                this.updateProgress();
            } catch (err) {
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—Å—Ç –∏–∑ –±—É—Ñ–µ—Ä–∞ –æ–±–º–µ–Ω–∞');
            }
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ —Ñ–∞–π–ª (—Ä–∞–±–æ—Ç–∞–µ—Ç –≤–µ–∑–¥–µ!)
        saveToFile() {
            const data = {
                notes: this.notes,
                version: '1.0',
                date: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `book-backup-${new Date().toISOString().slice(0,10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert('‚úÖ –ö–Ω–∏–≥–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤ —Ñ–∞–π–ª!');
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑ —Ñ–∞–π–ª–∞
        loadFromFile() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = (e) => {
                const file = e.target.files[0];
                const reader = new FileReader();
                
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        if (data.notes && Array.isArray(data.notes) && data.notes.length === this.totalPages) {
                            this.notes = data.notes;
                            this.saveNotes();
                            this.loadPage();
                            this.updateProgress();
                            alert('‚úÖ –ö–Ω–∏–≥–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –∏–∑ —Ñ–∞–π–ª–∞!');
                        } else {
                            alert('‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞');
                        }
                    } catch (err) {
                        alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞');
                    }
                };
                
                reader.readAsText(file);
            };
            
            input.click();
        }

        // –ü–æ–¥–µ–ª–∏—Ç—å—Å—è —Å—Å—ã–ª–∫–æ–π –Ω–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ
        shareBook() {
            const data = {
                notes: this.notes,
                version: '1.0'
            };
            
            const jsonStr = JSON.stringify(data);
            const compressed = btoa(encodeURIComponent(jsonStr)); // –ü—Ä–æ—Å—Ç–æ–µ –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ
            
            const url = window.location.href.split('?')[0] + '?data=' + compressed;
            
            navigator.clipboard.writeText(url).then(() => {
                alert(`‚úÖ –°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!\n\n–ü–æ —ç—Ç–æ–π —Å—Å—ã–ª–∫–µ –ª—é–±–æ–π –º–æ–∂–µ—Ç —Å–∫–∞—á–∞—Ç—å –≤–∞—à—É –∫–Ω–∏–≥—É.`);
            }).catch(() => {
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É');
            });
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Å—ã–ª–∫–∏ —Å –¥–∞–Ω–Ω—ã–º–∏
        checkUrlForData() {
            const urlParams = new URLSearchParams(window.location.search);
            const dataParam = urlParams.get('data');
            
            if (dataParam) {
                try {
                    const jsonStr = decodeURIComponent(atob(dataParam));
                    const data = JSON.parse(jsonStr);
                    
                    if (data.notes && Array.isArray(data.notes) && data.notes.length === this.totalPages) {
                        if (confirm('–ó–∞–≥—Ä—É–∑–∏—Ç—å –∫–Ω–∏–≥—É –∏–∑ —Å—Å—ã–ª–∫–∏? –¢–µ–∫—É—â–∞—è –∫–Ω–∏–≥–∞ –±—É–¥–µ—Ç –∑–∞–º–µ–Ω–µ–Ω–∞.')) {
                            this.notes = data.notes;
                            this.saveNotes();
                            this.loadPage();
                            this.updateProgress();
                            alert('‚úÖ –ö–Ω–∏–≥–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –∏–∑ —Å—Å—ã–ª–∫–∏!');
                        }
                    }
                } catch (err) {
                    console.log('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ —Å—Å—ã–ª–∫–∏');
                }
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        init() {
            this.loadPage();
            this.updateButtons();
            this.updateProgress();
            this.attachEventListeners();
            this.checkUrlForData();
            
            // –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏
            if (this.saveCloudBtn) {
                this.saveCloudBtn.textContent = 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ —Ñ–∞–π–ª';
            }
            if (this.loadCloudBtn) {
                this.loadCloudBtn.textContent = 'üìÇ –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ —Ñ–∞–π–ª–∞';
            }
            if (this.shareBtn) {
                this.shareBtn.textContent = 'üîó –°—Å—ã–ª–∫–∞ –Ω–∞ –∫–Ω–∏–≥—É';
            }
        }

        // –ü—Ä–∏–≤—è–∑–∫–∞ —Å–æ–±—ã—Ç–∏–π
        attachEventListeners() {
            this.firstBtn.addEventListener('click', () => this.firstPage());
            this.prevBtn.addEventListener('click', () => this.prevPage());
            this.nextBtn.addEventListener('click', () => this.nextPage());
            this.lastBtn.addEventListener('click', () => this.lastPage());

            this.pageInput.addEventListener('change', (e) => {
                let pageNumber = parseInt(e.target.value);
                if (isNaN(pageNumber) || pageNumber < 1) pageNumber = 1;
                if (pageNumber > this.totalPages) pageNumber = this.totalPages;
                e.target.value = pageNumber;
                this.goToPage(pageNumber);
            });

            this.writingArea.addEventListener('input', () => {
                this.saveCurrentPage();
                this.updateProgress();
            });

            this.writingArea.addEventListener('paste', (e) => {
                e.preventDefault();
                const text = e.clipboardData.getData('text/plain');
                document.execCommand('insertText', false, text);
                this.saveCurrentPage();
            });

            this.clearBtn.addEventListener('click', () => this.clearCurrentPage());
            this.resetAllBtn.addEventListener('click', () => this.resetAllPages());
            this.pastePlainBtn.addEventListener('click', () => this.pasteAsPlainText());
            
            // –ù–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
            this.saveCloudBtn.addEventListener('click', () => this.saveToFile());
            this.loadCloudBtn.addEventListener('click', () => this.loadFromFile());
            this.shareBtn.addEventListener('click', () => this.shareBook());

            document.addEventListener('keydown', (e) => {
                if (e.target === this.writingArea) return;
                
                if (e.key === 'ArrowRight' || e.key === 'ArrowDown') {
                    e.preventDefault();
                    this.nextPage();
                } else if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') {
                    e.preventDefault();
                    this.prevPage();
                } else if (e.key === 'Home') {
                    e.preventDefault();
                    this.firstPage();
                } else if (e.key === 'End') {
                    e.preventDefault();
                    this.lastPage();
                }
            });

            window.addEventListener('beforeunload', () => {
                this.saveCurrentPage();
            });
        }
    }

    // –°–æ–∑–¥–∞–µ–º –∫–Ω–∏–≥—É
    document.addEventListener('DOMContentLoaded', () => {
        window.book = new SimpleBook();
    });
</script>
