<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìö –ü–æ–∏—Å–∫ —Å –Ω–∞–≤–∏–≥–∞—Ü–∏–µ–π</title>
    
    <!-- –î–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–∞ –ü–ö -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2b4b3c">
    
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º —Ä–∞–∑–Ω—ã–µ —à—Ä–∏—Ñ—Ç—ã -->
    <link href="https://fonts.googleapis.com/css2?family=Caveat:wght@400;700&family=Comfortaa:wght@300;700&family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(145deg, #2b4b3c 0%, #1d352a 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: 'Courier New', 'Georgia', serif;
            padding: 20px;
        }

        .book-container {
            width: 1100px;
            max-width: 100%;
            position: relative;
        }

        /* –ö–Ω–æ–ø–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ */
        .install-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #d4af37;
            border: 2px solid #b87c4b;
            border-radius: 30px;
            padding: 12px 25px;
            color: #2c1810;
            cursor: pointer;
            font-family: 'Georgia', serif;
            font-weight: bold;
            display: none;
            z-index: 1000;
            font-size: 16px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        /* –ö–Ω–æ–ø–∫–∞ –¥–ª—è –ø–æ–∫–∞–∑–∞/—Å–∫—Ä—ã—Ç–∏—è –ø–∞–Ω–µ–ª–∏ —à—Ä–∏—Ñ—Ç–æ–≤ */
        .toggle-font-panel {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #d4af37;
            border: 2px solid #b87c4b;
            border-radius: 50px;
            padding: 15px 25px;
            color: #2c1810;
            cursor: pointer;
            font-family: 'Georgia', serif;
            font-weight: bold;
            z-index: 1001;
            font-size: 16px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.5);
            transition: all 0.3s;
        }

        /* –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —à—Ä–∏—Ñ—Ç–æ–º */
        .font-panel {
            position: fixed;
            bottom: 90px;
            right: 20px;
            background: rgba(44, 24, 16, 0.95);
            border: 2px solid #b87c4b;
            border-radius: 50px;
            padding: 15px 25px;
            display: none;
            gap: 15px;
            flex-wrap: wrap;
            z-index: 1000;
            backdrop-filter: blur(5px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.5);
            max-width: 90vw;
        }

        .font-panel.show {
            display: flex;
        }

        .font-group {
            display: flex;
            gap: 5px;
            align-items: center;
            flex-wrap: wrap;
        }

        .font-btn {
            background: rgba(184, 124, 75, 0.3);
            border: 1px solid #b87c4b;
            border-radius: 30px;
            padding: 8px 15px;
            color: #d4af37;
            cursor: pointer;
            font-family: 'Georgia', serif;
            transition: all 0.2s;
            font-size: 14px;
        }

        .font-btn:hover {
            background: rgba(184, 124, 75, 0.5);
        }

        .font-btn.active {
            background: #d4af37;
            color: #2c1810;
        }

        .size-btn {
            background: rgba(184, 124, 75, 0.3);
            border: 1px solid #b87c4b;
            border-radius: 30px;
            padding: 8px 15px;
            color: #d4af37;
            cursor: pointer;
            font-family: 'Georgia', serif;
            min-width: 40px;
            text-align: center;
        }

        .size-btn:hover {
            background: rgba(184, 124, 75, 0.5);
        }

        .separator {
            width: 1px;
            background: #b87c4b;
            margin: 0 5px;
        }

        /* –ü–∞–Ω–µ–ª—å —Å –∫–Ω–∏–≥–∞–º–∏ */
        .books-panel {
            background: rgba(44, 24, 16, 0.95);
            border: 2px solid #b87c4b;
            border-radius: 60px;
            padding: 15px 25px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .books-list {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
            max-height: 200px;
            overflow-y: auto;
            padding: 5px;
        }

        .book-tab {
            background: rgba(184, 124, 75, 0.3);
            border: 1px solid #b87c4b;
            border-radius: 30px;
            padding: 8px 15px;
            color: #d4af37;
            cursor: pointer;
            font-family: 'Georgia', serif;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .book-tab:hover {
            background: rgba(184, 124, 75, 0.5);
            transform: scale(1.02);
        }

        .book-tab.active {
            background: #d4af37;
            color: #2c1810;
        }

        .delete-book {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: rgba(196, 75, 75, 0.3);
            color: #c44b4b;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            cursor: pointer;
        }

        .delete-book:hover {
            background: #c44b4b;
            color: white;
        }

        /* –ü–∞–Ω–µ–ª—å –ø–æ–∏—Å–∫–∞ */
        .search-panel {
            background: rgba(44, 24, 16, 0.95);
            border: 2px solid #b87c4b;
            border-radius: 60px;
            padding: 10px 20px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .search-input-wrapper {
            flex: 1;
            display: flex;
            align-items: center;
            background: rgba(255, 252, 240, 0.9);
            border: 2px solid #b87c4b;
            border-radius: 30px;
            padding: 2px;
        }

        .search-input {
            flex: 1;
            background: transparent;
            border: none;
            padding: 12px 20px;
            font-family: 'Georgia', serif;
            font-size: 16px;
            color: #2c1810;
            outline: none;
        }

        .clear-search {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(196, 75, 75, 0.2);
            color: #c44b4b;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
            margin-right: 5px;
            transition: all 0.2s;
        }

        .clear-search:hover {
            background: #c44b4b;
            color: white;
        }

        .search-btn {
            background: #d4af37;
            border: 2px solid #b87c4b;
            border-radius: 30px;
            padding: 10px 20px;
            color: #2c1810;
            cursor: pointer;
            font-family: 'Georgia', serif;
            font-weight: bold;
            transition: all 0.2s;
        }

        .search-btn:hover {
            background: #e5c158;
            transform: scale(1.05);
        }

        /* –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ */
        .search-results {
            background: rgba(44, 24, 16, 0.95);
            border: 2px solid #b87c4b;
            border-radius: 30px;
            padding: 15px;
            margin-bottom: 20px;
            color: #d4af37;
            font-family: 'Georgia', serif;
            max-height: 300px;
            overflow-y: auto;
            display: none;
        }

        .search-results.show {
            display: block;
        }

        .search-result-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            margin: 5px 0;
            background: rgba(184, 124, 75, 0.2);
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.2s;
            border-left: 4px solid #d4af37;
        }

        .search-result-item:hover {
            background: rgba(184, 124, 75, 0.4);
            transform: translateX(5px);
        }

        .search-result-number {
            width: 30px;
            height: 30px;
            background: #d4af37;
            color: #2c1810;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
        }

        .search-result-content {
            flex: 1;
        }

        .search-result-preview {
            color: #fffcf0;
            font-size: 14px;
            margin: 5px 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .search-result-location {
            color: #b87c4b;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .search-result-arrow {
            font-size: 20px;
            color: #d4af37;
            opacity: 0.7;
        }

        .search-result-item:hover .search-result-arrow {
            opacity: 1;
            transform: translateX(5px);
        }

        .search-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #b87c4b;
        }

        .search-stats {
            font-size: 14px;
            color: #b87c4b;
        }

        .close-search {
            cursor: pointer;
            color: #c44b4b;
            font-size: 20px;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: rgba(196, 75, 75, 0.2);
        }

        .close-search:hover {
            background: #c44b4b;
            color: white;
        }

        .highlight {
            background-color: #ffeb3b;
            color: #2c1810 !important;
            padding: 2px;
            border-radius: 3px;
            font-weight: bold;
        }

        .current-highlight {
            background-color: #ff9800 !important;
            color: #2c1810 !important;
            padding: 2px;
            border-radius: 3px;
            font-weight: bold;
            box-shadow: 0 0 0 2px #ff5722;
        }

        .page {
            width: 100%;
            height: 450px;
            max-height: 55vh;
            background: #fffcf0;
            border-radius: 20px;
            box-shadow: 
                0 20px 40px rgba(0, 0, 0, 0.6),
                0 0 0 2px #b87c4b,
                0 0 0 6px #5d3a1a;
            padding: 30px 40px;
            position: relative;
            overflow-y: auto;
            font-family: 'Courier New', 'Georgia', serif;
            font-size: 18px;
            color: #3b2b1a;
            line-height: 1.8;
            transition: all 0.2s;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #d4b99b;
            font-family: 'Georgia', serif;
            font-style: italic;
            color: #8b6b4f;
        }

        .book-title {
            font-weight: bold;
            color: #6b4a2c;
            font-size: 20px;
        }

        .writing-area {
            width: 100%;
            min-height: calc(100% - 80px);
            outline: none;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: inherit;
            font-size: inherit;
            line-height: inherit;
            color: inherit;
        }

        .writing-area:empty:before {
            content: attr(placeholder);
            color: #b8a692;
            font-style: italic;
            opacity: 0.7;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .action-btn {
            background: #d4af37;
            border: 2px solid #b87c4b;
            border-radius: 30px;
            padding: 10px 25px;
            font-size: 16px;
            color: #2c1810;
            cursor: pointer;
            font-family: 'Georgia', serif;
            font-weight: bold;
            transition: all 0.2s;
        }

        .action-btn:hover {
            background: #e5c158;
            transform: scale(1.05);
        }

        .status {
            text-align: center;
            margin-top: 15px;
            color: #d4af37;
            font-size: 14px;
            min-height: 20px;
        }

        .bookmark {
            position: absolute;
            top: -5px;
            right: 30px;
            width: 30px;
            height: 70px;
            background: #c44b4b;
            border-radius: 0 0 10px 10px;
            z-index: 30;
        }

        .offline-badge {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: #c44b4b;
            color: white;
            padding: 8px 20px;
            border-radius: 30px;
            font-size: 14px;
            display: none;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            z-index: 1000;
        }

        .offline-badge.show {
            display: block;
        }

        /* –ù–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ */
        .search-navigation {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-left: auto;
        }

        .nav-arrow {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #d4af37;
            color: #2c1810;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 20px;
            border: 2px solid #b87c4b;
        }

        .nav-arrow:hover {
            background: #e5c158;
            transform: scale(1.05);
        }

        .nav-arrow.disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .nav-arrow.disabled:hover {
            transform: none;
            background: #d4af37;
        }
    </style>
</head>
<body>
    <button class="install-btn" id="installBtn">üì• –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–∞ –ü–ö</button>
    <div class="offline-badge" id="offlineBadge">üì¥ –†–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞</div>

    <!-- –ö–Ω–æ–ø–∫–∞ –¥–ª—è –ø–æ–∫–∞–∑–∞/—Å–∫—Ä—ã—Ç–∏—è –ø–∞–Ω–µ–ª–∏ —à—Ä–∏—Ñ—Ç–æ–≤ -->
    <button class="toggle-font-panel" id="toggleFontPanel">‚úé –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —à—Ä–∏—Ñ—Ç–∞</button>

    <!-- –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —à—Ä–∏—Ñ—Ç–æ–º -->
    <div class="font-panel" id="fontPanel">
        <div class="font-group">
            <button class="font-btn" data-font="default">üìù –û–±—ã—á–Ω—ã–π</button>
            <button class="font-btn" data-font="hand">‚úçÔ∏è –†—É–∫–æ–ø–∏—Å–Ω—ã–π</button>
            <button class="font-btn" data-font="print">üñ®Ô∏è –ü–µ—á–∞—Ç–Ω—ã–π</button>
            <button class="font-btn" data-font="modern">üíª –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π</button>
        </div>
        
        <div class="separator"></div>
        
        <div class="font-group">
            <button class="size-btn" data-size="14">A-</button>
            <button class="size-btn" data-size="18">A</button>
            <button class="size-btn" data-size="22">A+</button>
            <button class="size-btn" data-size="26">A++</button>
        </div>
        
        <div class="separator"></div>
        
        <div class="font-group">
            <button class="size-btn" data-line="1.4">–°—Ç—Ä–æ–∫–∏ ‚ñº</button>
            <button class="size-btn" data-line="1.8">–°—Ç—Ä–æ–∫–∏ ‚Ä¢</button>
            <button class="size-btn" data-line="2.2">–°—Ç—Ä–æ–∫–∏ ‚ñ≤</button>
        </div>
    </div>

    <div class="book-container">
        <!-- –ü–∞–Ω–µ–ª—å —Å–æ –≤—Å–µ–º–∏ –∫–Ω–∏–≥–∞–º–∏ -->
        <div class="books-panel">
            <span style="color: #d4af37;">üìö –ú–æ–∏ –∫–Ω–∏–≥–∏ (<span id="bookCount">0</span>):</span>
            <div class="books-list" id="booksList"></div>
            <button class="action-btn" id="addFromLinkBtn" style="padding: 5px 15px;">‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø–æ —Å—Å—ã–ª–∫–µ</button>
        </div>

        <!-- –ü–∞–Ω–µ–ª—å –ø–æ–∏—Å–∫–∞ -->
        <div class="search-panel">
            <div class="search-input-wrapper">
                <input type="text" id="searchInput" class="search-input" placeholder="üîç –ù–∞–π—Ç–∏ —Å–ª–æ–≤–æ –≤ —ç—Ç–æ–π –∫–Ω–∏–≥–µ...">
                <div class="clear-search" id="clearSearch" title="–û—á–∏—Å—Ç–∏—Ç—å –ø–æ–∏—Å–∫">‚úï</div>
            </div>
            <button class="search-btn" id="searchBtn">–ù–∞–π—Ç–∏</button>
            <div class="search-navigation" id="searchNavigation" style="display: none;">
                <div class="nav-arrow" id="prevMatch">‚Üê</div>
                <span id="matchCounter">0/0</span>
                <div class="nav-arrow" id="nextMatch">‚Üí</div>
            </div>
        </div>

        <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ -->
        <div class="search-results" id="searchResults">
            <div class="search-header">
                <span id="searchResultsTitle">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞</span>
                <span class="search-stats" id="searchStats"></span>
                <span class="close-search" id="closeSearch" title="–ó–∞–∫—Ä—ã—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã">‚úï</span>
            </div>
            <div id="searchResultsList"></div>
        </div>

        <!-- –°—Ç—Ä–∞–Ω–∏—Ü–∞ -->
        <div class="page" id="page">
            <div class="page-header">
                <span class="book-title" id="currentBookTitle">–ö–Ω–∏–≥–∞ 1</span>
                <span>‚úé</span>
            </div>
            
            <div id="writingArea" 
                 class="writing-area" 
                 contenteditable="true"
                 placeholder="‚úçÔ∏è –ü–∏—à–∏ —á—Ç–æ —Ö–æ—á–µ—à—å...">
            </div>
        </div>

        <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
        <div class="action-buttons">
            <button class="action-btn" id="addBookBtn">‚ûï –ù–æ–≤–∞—è</button>
            <button class="action-btn" id="renameBookBtn">‚úèÔ∏è –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å</button>
            <button class="action-btn" id="deleteBookBtn">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
            <button class="action-btn" id="shareBookBtn">üîó –ü–æ–¥–µ–ª–∏—Ç—å—Å—è</button>
        </div>

        <div class="status" id="status"></div>
        <div class="bookmark"></div>
    </div>

    <script>
        class BookApp {
            constructor() {
                this.writingArea = document.getElementById('writingArea');
                this.booksList = document.getElementById('booksList');
                this.currentBookTitle = document.getElementById('currentBookTitle');
                this.status = document.getElementById('status');
                this.offlineBadge = document.getElementById('offlineBadge');
                this.page = document.getElementById('page');
                this.bookCount = document.getElementById('bookCount');
                this.searchInput = document.getElementById('searchInput');
                this.searchBtn = document.getElementById('searchBtn');
                this.searchResults = document.getElementById('searchResults');
                this.searchResultsList = document.getElementById('searchResultsList');
                this.closeSearch = document.getElementById('closeSearch');
                this.clearSearch = document.getElementById('clearSearch');
                this.searchNavigation = document.getElementById('searchNavigation');
                this.matchCounter = document.getElementById('matchCounter');
                this.prevMatch = document.getElementById('prevMatch');
                this.nextMatch = document.getElementById('nextMatch');
                this.searchStats = document.getElementById('searchStats');
                
                // –î–∞–Ω–Ω—ã–µ –¥–ª—è –ø–æ–∏—Å–∫–∞
                this.matches = [];
                this.currentMatchIndex = -1;
                
                // –ï–¥–∏–Ω—ã–π –º–∞—Å—Å–∏–≤ –¥–ª—è –≤—Å–µ—Ö –∫–Ω–∏–≥
                this.books = [];
                this.currentBookId = null;
                
                // –°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —à—Ä–∏—Ñ—Ç–∞
                this.loadFontSettings();
                
                this.init();
                this.checkOnline();
                this.setupInstall();
                
                document.getElementById('toggleFontPanel').addEventListener('click', () => this.toggleFontPanel());
                document.getElementById('addFromLinkBtn').addEventListener('click', () => this.addFromLink());
                
                // –ü–æ–∏—Å–∫
                this.searchBtn.addEventListener('click', () => this.searchInBook());
                this.searchInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.searchInBook();
                });
                
                // –û—á–∏—Å—Ç–∫–∞ –∏ –∑–∞–∫—Ä—ã—Ç–∏–µ
                this.closeSearch.addEventListener('click', () => this.exitSearch());
                this.clearSearch.addEventListener('click', () => this.clearSearchInput());
                
                // –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º
                this.prevMatch.addEventListener('click', () => this.navigateMatches('prev'));
                this.nextMatch.addEventListener('click', () => this.navigateMatches('next'));
                
                // –ù–∞–∑–Ω–∞—á–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ —à—Ä–∏—Ñ—Ç–∞
                this.setupFontButtons();
            }

            // –û—á–∏—Å—Ç–∏—Ç—å –ø–æ–ª–µ –ø–æ–∏—Å–∫–∞
            clearSearchInput() {
                this.searchInput.value = '';
                this.searchInput.focus();
                this.exitSearch();
            }

            // –ü–æ–ª–Ω—ã–π –≤—ã—Ö–æ–¥ –∏–∑ –ø–æ–∏—Å–∫–∞
            exitSearch() {
                this.hideSearchResults();
                this.searchNavigation.style.display = 'none';
                this.clearHighlights();
                this.matches = [];
                this.currentMatchIndex = -1;
                this.showStatus('üîç –ü–æ–∏—Å–∫ –∑–∞–≤–µ—Ä—à–µ–Ω');
            }

            // –ü–æ–∏—Å–∫ –≤ —Ç–µ–∫—É—â–µ–π –∫–Ω–∏–≥–µ
            searchInBook() {
                const searchText = this.searchInput.value.trim();
                if (!searchText) {
                    this.showStatus('‚ùå –í–≤–µ–¥–∏—Ç–µ —Å–ª–æ–≤–æ –¥–ª—è –ø–æ–∏—Å–∫–∞');
                    return;
                }

                const book = this.books.find(b => b.id === this.currentBookId);
                if (!book) return;

                // –ü–æ–ª—É—á–∞–µ–º —á–∏—Å—Ç—ã–π —Ç–µ–∫—Å—Ç
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = book.content;
                const plainText = tempDiv.textContent || tempDiv.innerText || '';

                // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è
                const regex = new RegExp(searchText.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
                this.matches = [];
                let match;

                // –û—á–∏—â–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É
                this.clearHighlights();

                while ((match = regex.exec(plainText)) !== null) {
                    this.matches.push({
                        index: match.index,
                        word: match[0],
                        length: match[0].length
                    });
                }

                if (this.matches.length === 0) {
                    this.showStatus('üîç –ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
                    this.exitSearch();
                    return;
                }

                // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –≤—Å–µ –≤—Ö–æ–∂–¥–µ–Ω–∏—è
                this.highlightAllMatches(searchText);
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
                this.showSearchResultsList(searchText);
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–∞–≤–∏–≥–∞—Ü–∏—é
                this.searchNavigation.style.display = 'flex';
                this.currentMatchIndex = 0;
                this.updateMatchCounter();
                this.highlightCurrentMatch();

                this.searchResults.classList.add('show');
                this.searchStats.textContent = `–ù–∞–π–¥–µ–Ω–æ: ${this.matches.length}`;
            }

            // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –≤—Å–µ—Ö –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö —Å–ª–æ–≤
            highlightAllMatches(searchText) {
                const content = this.writingArea.innerHTML;
                const regex = new RegExp(`(${searchText.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
                this.writingArea.innerHTML = content.replace(regex, '<span class="highlight">$1</span>');
            }

            // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è
            highlightCurrentMatch() {
                // –°–Ω–∞—á–∞–ª–∞ —É–±–∏—Ä–∞–µ–º –æ—Ä–∞–Ω–∂–µ–≤—É—é –ø–æ–¥—Å–≤–µ—Ç–∫—É —Å–æ –≤—Å–µ—Ö
                const highlights = document.querySelectorAll('.highlight');
                highlights.forEach(h => {
                    h.classList.remove('current-highlight');
                });

                // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º —Ç–µ–∫—É—â–µ–µ –æ—Ä–∞–Ω–∂–µ–≤—ã–º
                if (this.currentMatchIndex >= 0 && highlights.length > this.currentMatchIndex) {
                    highlights[this.currentMatchIndex].classList.add('current-highlight');
                    
                    // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ —Ç–µ–∫—É—â–µ–º—É —Å–æ–≤–ø–∞–¥–µ–Ω–∏—é
                    highlights[this.currentMatchIndex].scrollIntoView({
                        behavior: 'smooth',
                        block: 'center'
                    });
                }
            }

            // –û—á–∏—Å—Ç–∫–∞ –ø–æ–¥—Å–≤–µ—Ç–∫–∏
            clearHighlights() {
                const content = this.writingArea.innerHTML;
                this.writingArea.innerHTML = content.replace(/<span class="highlight">(.*?)<\/span>/g, '$1');
            }

            // –ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
            showSearchResultsList(searchText) {
                let html = '';
                
                this.matches.forEach((match, index) => {
                    const book = this.books.find(b => b.id === this.currentBookId);
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = book.content;
                    const plainText = tempDiv.textContent || tempDiv.innerText || '';
                    
                    // –ö–æ–Ω—Ç–µ–∫—Å—Ç (30 —Å–∏–º–≤–æ–ª–æ–≤ –¥–æ –∏ –ø–æ—Å–ª–µ)
                    const start = Math.max(0, match.index - 30);
                    const end = Math.min(plainText.length, match.index + match.length + 30);
                    let preview = plainText.substring(start, end);
                    
                    // –í—ã–¥–µ–ª—è–µ–º –Ω–∞–π–¥–µ–Ω–Ω–æ–µ —Å–ª–æ–≤–æ
                    preview = preview.replace(
                        new RegExp(`(${searchText})`, 'gi'),
                        '<span style="background: #ffeb3b; color: #2c1810; padding: 2px;">$1</span>'
                    );
                    
                    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é (—Å—Ç—Ä–æ–∫–∞)
                    const lineNumber = (plainText.substring(0, match.index).match(/\n/g) || []).length + 1;
                    
                    html += `
                        <div class="search-result-item" onclick="app.goToMatch(${index})">
                            <div class="search-result-number">${index + 1}</div>
                            <div class="search-result-content">
                                <div class="search-result-preview">${preview}</div>
                                <div class="search-result-location">
                                    <span>üìç –°—Ç—Ä–æ–∫–∞ ${lineNumber}</span>
                                    <span class="search-result-arrow">‚Üí</span>
                                </div>
                            </div>
                        </div>
                    `;
                });

                this.searchResultsList.innerHTML = html;
            }

            // –ü–µ—Ä–µ–π—Ç–∏ –∫ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É —Å–æ–≤–ø–∞–¥–µ–Ω–∏—é
            goToMatch(index) {
                this.currentMatchIndex = index;
                this.highlightCurrentMatch();
                this.updateMatchCounter();
                
                // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞
                const highlights = document.querySelectorAll('.highlight');
                if (highlights[index]) {
                    highlights[index].scrollIntoView({
                        behavior: 'smooth',
                        block: 'center'
                    });
                }
            }

            // –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ —Å—Ç—Ä–µ–ª–∫–∞–º
            navigateMatches(direction) {
                if (this.matches.length === 0) return;
                
                if (direction === 'next') {
                    this.currentMatchIndex = (this.currentMatchIndex + 1) % this.matches.length;
                } else {
                    this.currentMatchIndex = (this.currentMatchIndex - 1 + this.matches.length) % this.matches.length;
                }
                
                this.highlightCurrentMatch();
                this.updateMatchCounter();
            }

            // –û–±–Ω–æ–≤–∏—Ç—å —Å—á–µ—Ç—á–∏–∫
            updateMatchCounter() {
                this.matchCounter.textContent = `${this.currentMatchIndex + 1}/${this.matches.length}`;
            }

            // –°–∫—Ä—ã—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞
            hideSearchResults() {
                this.searchResults.classList.remove('show');
            }

            // –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ —à—Ä–∏—Ñ—Ç–∞ –∏–∑ localStorage
            loadFontSettings() {
                const savedFont = localStorage.getItem('fontStyle') || 'default';
                const savedSize = localStorage.getItem('fontSize') || '18';
                const savedLine = localStorage.getItem('lineHeight') || '1.8';
                
                this.applyFont(savedFont);
                this.page.style.fontSize = savedSize + 'px';
                this.page.style.lineHeight = savedLine;
            }

            // –ü—Ä–∏–º–µ–Ω–∏—Ç—å —à—Ä–∏—Ñ—Ç
            applyFont(style) {
                switch(style) {
                    case 'default':
                        this.page.style.fontFamily = "'Courier New', 'Georgia', serif";
                        break;
                    case 'hand':
                        this.page.style.fontFamily = "'Caveat', 'Courier New', cursive";
                        break;
                    case 'print':
                        this.page.style.fontFamily = "'Times New Roman', 'Georgia', serif";
                        break;
                    case 'modern':
                        this.page.style.fontFamily = "'Roboto', 'Arial', sans-serif";
                        break;
                }
                localStorage.setItem('fontStyle', style);
            }

            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–Ω–æ–ø–æ–∫ —à—Ä–∏—Ñ—Ç–∞
            setupFontButtons() {
                document.querySelectorAll('.font-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        document.querySelectorAll('.font-btn').forEach(b => b.classList.remove('active'));
                        e.target.classList.add('active');
                        
                        const font = e.target.dataset.font;
                        this.applyFont(font);
                        this.showStatus('‚ú® –®—Ä–∏—Ñ—Ç –∏–∑–º–µ–Ω–µ–Ω');
                    });
                });

                document.querySelectorAll('.size-btn[data-size]').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const size = e.target.dataset.size;
                        this.page.style.fontSize = size + 'px';
                        localStorage.setItem('fontSize', size);
                        this.showStatus('üìè –†–∞–∑–º–µ—Ä: ' + size + 'px');
                    });
                });

                document.querySelectorAll('.size-btn[data-line]').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const line = e.target.dataset.line;
                        this.page.style.lineHeight = line;
                        localStorage.setItem('lineHeight', line);
                        this.showStatus('üìê –ò–Ω—Ç–µ—Ä–≤–∞–ª: ' + line);
                    });
                });

                const savedFont = localStorage.getItem('fontStyle') || 'default';
                document.querySelectorAll('.font-btn').forEach(btn => {
                    if (btn.dataset.font === savedFont) {
                        btn.classList.add('active');
                    }
                });
            }

            toggleFontPanel() {
                const panel = document.getElementById('fontPanel');
                const btn = document.getElementById('toggleFontPanel');
                
                if (panel.classList.contains('show')) {
                    panel.classList.remove('show');
                    btn.textContent = '‚úé –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —à—Ä–∏—Ñ—Ç–∞';
                } else {
                    panel.classList.add('show');
                    btn.textContent = '‚úï –ó–∞–∫—Ä—ã—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏';
                }
            }

            showStatus(message) {
                this.status.textContent = message;
                setTimeout(() => {
                    this.status.textContent = '';
                }, 1500);
            }

            addFromLink() {
                const url = prompt('–í—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ –∫–Ω–∏–≥—É:', '');
                if (!url) return;
                
                try {
                    const urlParams = new URLSearchParams(new URL(url).search);
                    const data = urlParams.get('data');
                    
                    if (data) {
                        const jsonStr = decodeURIComponent(atob(data));
                        const bookData = JSON.parse(jsonStr);
                        
                        if (bookData.books) {
                            const bookId = Object.keys(bookData.books)[0];
                            const book = bookData.books[bookId];
                            
                            this.books.push({
                                id: 'book_' + Date.now() + '_' + Math.random().toString(36).substring(2, 6),
                                title: book.title,
                                content: book.content
                            });
                            
                            this.saveBooks();
                            this.renderBooksList();
                            
                            this.currentBookId = this.books[this.books.length - 1].id;
                            this.loadCurrentBook();
                            
                            this.showStatus('‚úÖ –ö–Ω–∏–≥–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞');
                        }
                    }
                } catch (e) {
                    this.showStatus('‚ùå –ù–µ–≤–µ—Ä–Ω–∞—è —Å—Å—ã–ª–∫–∞');
                }
            }

            checkOnline() {
                window.addEventListener('offline', () => {
                    this.offlineBadge.classList.add('show');
                });
                
                window.addEventListener('online', () => {
                    this.offlineBadge.classList.remove('show');
                });
                
                if (!navigator.onLine) {
                    this.offlineBadge.classList.add('show');
                }
            }

            setupInstall() {
                let deferredPrompt;
                const installBtn = document.getElementById('installBtn');
                
                window.addEventListener('beforeinstallprompt', (e) => {
                    e.preventDefault();
                    deferredPrompt = e;
                    installBtn.style.display = 'block';
                });

                installBtn.addEventListener('click', async () => {
                    if (!deferredPrompt) return;
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    if (outcome === 'accepted') {
                        installBtn.style.display = 'none';
                    }
                });
            }

            init() {
                this.loadFromUrl();
                this.loadBooks();
                
                if (this.books.length === 0) {
                    this.createNewBook('–ú–æ—è –∫–Ω–∏–≥–∞');
                }
                
                const lastBookId = localStorage.getItem('lastBookId');
                if (lastBookId && this.books.find(b => b.id === lastBookId)) {
                    this.currentBookId = lastBookId;
                } else {
                    this.currentBookId = this.books[0].id;
                }
                
                this.loadCurrentBook();
                this.renderBooksList();
                this.attachEvents();
            }

            loadFromUrl() {
                const urlParams = new URLSearchParams(window.location.search);
                const data = urlParams.get('data');
                
                if (data) {
                    try {
                        const jsonStr = decodeURIComponent(atob(data));
                        const bookData = JSON.parse(jsonStr);
                        
                        if (bookData.books) {
                            const bookId = Object.keys(bookData.books)[0];
                            const book = bookData.books[bookId];
                            
                            this.books.push({
                                id: 'book_' + Date.now() + '_' + Math.random().toString(36).substring(2, 6),
                                title: book.title,
                                content: book.content
                            });
                            
                            this.saveBooks();
                            this.showStatus('‚úÖ –ö–Ω–∏–≥–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞');
                            return true;
                        }
                    } catch (e) {}
                }
                return false;
            }

            saveBooks() {
                localStorage.setItem('allBooks', JSON.stringify(this.books));
                this.bookCount.textContent = this.books.length;
            }

            loadBooks() {
                const saved = localStorage.getItem('allBooks');
                if (saved) {
                    try {
                        this.books = JSON.parse(saved);
                    } catch (e) {}
                }
            }

            loadCurrentBook() {
                const book = this.books.find(b => b.id === this.currentBookId);
                if (book) {
                    this.writingArea.innerHTML = book.content || '';
                    this.currentBookTitle.textContent = book.title;
                    localStorage.setItem('lastBookId', this.currentBookId);
                    this.exitSearch(); // –í—ã—Ö–æ–¥–∏–º –∏–∑ –ø–æ–∏—Å–∫–∞ –ø—Ä–∏ —Å–º–µ–Ω–µ –∫–Ω–∏–≥–∏
                }
            }

            createNewBook(title) {
                const newBook = {
                    id: 'book_' + Date.now() + '_' + Math.random().toString(36).substring(2, 6),
                    title: title,
                    content: ''
                };
                
                this.books.push(newBook);
                this.currentBookId = newBook.id;
                this.saveBooks();
                this.loadCurrentBook();
                this.renderBooksList();
                this.showStatus('‚úÖ –ù–æ–≤–∞—è –∫–Ω–∏–≥–∞ —Å–æ–∑–¥–∞–Ω–∞');
            }

            switchBook(id) {
                const currentBook = this.books.find(b => b.id === this.currentBookId);
                if (currentBook) {
                    currentBook.content = this.writingArea.innerHTML;
                }
                
                this.currentBookId = id;
                this.loadCurrentBook();
                this.saveBooks();
                this.renderBooksList();
            }

            deleteCurrentBook() {
                if (this.books.length <= 1) {
                    this.showStatus('‚ùå –ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω—é—é –∫–Ω–∏–≥—É');
                    return;
                }
                
                const currentBook = this.books.find(b => b.id === this.currentBookId);
                if (confirm(`–£–¥–∞–ª–∏—Ç—å –∫–Ω–∏–≥—É "${currentBook.title}"?`)) {
                    const currentIndex = this.books.findIndex(b => b.id === this.currentBookId);
                    
                    this.books = this.books.filter(b => b.id !== this.currentBookId);
                    
                    const newIndex = currentIndex > 0 ? currentIndex - 1 : 0;
                    this.currentBookId = this.books[newIndex].id;
                    
                    this.saveBooks();
                    this.loadCurrentBook();
                    this.renderBooksList();
                    this.showStatus('üóëÔ∏è –ö–Ω–∏–≥–∞ —É–¥–∞–ª–µ–Ω–∞');
                }
            }

            renameCurrentBook() {
                const book = this.books.find(b => b.id === this.currentBookId);
                const newTitle = prompt('–ù–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ:', book.title);
                if (newTitle && newTitle.trim()) {
                    book.title = newTitle.trim();
                    this.currentBookTitle.textContent = newTitle.trim();
                    this.saveBooks();
                    this.renderBooksList();
                    this.showStatus('‚úèÔ∏è –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–æ');
                }
            }

            shareCurrentBook() {
                const book = this.books.find(b => b.id === this.currentBookId);
                book.content = this.writingArea.innerHTML;
                this.saveBooks();
                
                const shareData = {
                    books: {
                        [book.id]: {
                            title: book.title,
                            content: book.content
                        }
                    }
                };
                
                const jsonStr = JSON.stringify(shareData);
                const encoded = btoa(encodeURIComponent(jsonStr));
                const url = window.location.href.split('?')[0] + '?data=' + encoded;
                
                navigator.clipboard.writeText(url).then(() => {
                    this.showStatus('‚úÖ –°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!');
                }).catch(() => {
                    prompt('–°–∫–æ–ø–∏—Ä—É–π —Å—Å—ã–ª–∫—É:', url);
                });
            }

            deleteBook(id, event) {
                event.stopPropagation();
                
                if (this.books.length <= 1) {
                    this.showStatus('‚ùå –ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω—é—é –∫–Ω–∏–≥—É');
                    return;
                }
                
                const book = this.books.find(b => b.id === id);
                if (confirm(`–£–¥–∞–ª–∏—Ç—å –∫–Ω–∏–≥—É "${book.title}"?`)) {
                    if (id === this.currentBookId) {
                        const currentIndex = this.books.findIndex(b => b.id === id);
                        this.books = this.books.filter(b => b.id !== id);
                        const newIndex = currentIndex > 0 ? currentIndex - 1 : 0;
                        this.currentBookId = this.books[newIndex].id;
                        this.loadCurrentBook();
                    } else {
                        this.books = this.books.filter(b => b.id !== id);
                    }
                    
                    this.saveBooks();
                    this.renderBooksList();
                    this.showStatus('üóëÔ∏è –ö–Ω–∏–≥–∞ —É–¥–∞–ª–µ–Ω–∞');
                }
            }

            renderBooksList() {
                let html = '';
                this.bookCount.textContent = this.books.length;
                
                this.books.forEach(book => {
                    const isActive = book.id === this.currentBookId ? 'active' : '';
                    
                    html += `
                        <div class="book-tab ${isActive}" onclick="app.switchBook('${book.id}')">
                            <span>${book.title}</span>
                            <span class="delete-book" onclick="app.deleteBook('${book.id}', event)">‚úï</span>
                        </div>
                    `;
                });
                
                this.booksList.innerHTML = html;
            }

            attachEvents() {
                this.writingArea.addEventListener('input', () => {
                    const book = this.books.find(b => b.id === this.currentBookId);
                    if (book) {
                        book.content = this.writingArea.innerHTML;
                        this.saveBooks();
                    }
                });

                document.getElementById('addBookBtn').addEventListener('click', () => {
                    const title = prompt('–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–π –∫–Ω–∏–≥–∏:', '–ù–æ–≤–∞—è –∫–Ω–∏–≥–∞');
                    if (title) this.createNewBook(title);
                });

                document.getElementById('renameBookBtn').addEventListener('click', () => {
                    this.renameCurrentBook();
                });

                document.getElementById('deleteBookBtn').addEventListener('click', () => {
                    this.deleteCurrentBook();
                });

                document.getElementById('shareBookBtn').addEventListener('click', () => {
                    this.shareCurrentBook();
                });
            }
        }

        const app = new BookApp();
        window.app = app;
    </script>
</body>
</html>
