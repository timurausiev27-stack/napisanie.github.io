<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìö –ö–Ω–∏–≥–∏ —Å —É–¥–∞–ª–µ–Ω–∏–µ–º</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(145deg, #2b4b3c 0%, #1d352a 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: 'Courier New', 'Georgia', serif;
            padding: 20px;
        }

        .book-container {
            width: 800px;
            max-width: 100%;
            position: relative;
        }

        .page {
            width: 100%;
            height: 600px;
            max-height: 80vh;
            background: #fffcf0;
            border-radius: 20px;
            box-shadow: 
                0 20px 40px rgba(0, 0, 0, 0.6),
                0 0 0 2px #b87c4b,
                0 0 0 6px #5d3a1a;
            padding: 40px 50px;
            position: relative;
            overflow-y: auto;
            font-family: 'Courier New', 'Georgia', serif;
            font-size: 18px;
            color: #3b2b1a;
            line-height: 1.8;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 2px solid #d4b99b;
            font-family: 'Georgia', serif;
            font-style: italic;
            color: #8b6b4f;
        }

        .book-title {
            font-size: 20px;
            font-weight: bold;
            color: #6b4a2c;
        }

        .writing-area {
            width: 100%;
            min-height: calc(100% - 100px);
            outline: none;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: 'Courier New', 'Georgia', serif;
            font-size: 18px;
            line-height: 1.8;
            color: #3b2b1a;
        }

        .writing-area:empty:before {
            content: attr(placeholder);
            color: #b8a692;
            font-style: italic;
            opacity: 0.7;
        }

        .books-panel {
            background: rgba(44, 24, 16, 0.95);
            border: 2px solid #b87c4b;
            border-radius: 60px;
            padding: 15px 25px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .books-list {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        .book-tab {
            background: rgba(184, 124, 75, 0.3);
            border: 1px solid #b87c4b;
            border-radius: 30px;
            padding: 8px 15px;
            color: #d4af37;
            cursor: pointer;
            font-family: 'Georgia', serif;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .book-tab.active {
            background: #d4af37;
            color: #2c1810;
        }

        .delete-book {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: rgba(196, 75, 75, 0.3);
            color: #c44b4b;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .delete-book:hover {
            background: #c44b4b;
            color: white;
            transform: scale(1.1);
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .action-btn {
            background: #d4af37;
            border: 2px solid #b87c4b;
            border-radius: 30px;
            padding: 10px 25px;
            font-size: 16px;
            color: #2c1810;
            cursor: pointer;
            font-family: 'Georgia', serif;
            font-weight: bold;
            transition: all 0.2s;
        }

        .action-btn:hover {
            background: #e5c158;
            transform: scale(1.05);
        }

        .action-btn.danger {
            background: rgba(196, 75, 75, 0.3);
            border-color: #c44b4b;
            color: #c44b4b;
        }

        .action-btn.danger:hover {
            background: #c44b4b;
            color: white;
        }

        .bookmark {
            position: absolute;
            top: -5px;
            right: 30px;
            width: 30px;
            height: 60px;
            background: #c44b4b;
            border-radius: 0 0 10px 10px;
            z-index: 30;
        }

        .bookmark::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 5px;
            width: 20px;
            height: 20px;
            background: #c44b4b;
            clip-path: polygon(0 0, 100% 0, 50% 100%);
        }

        .status {
            text-align: center;
            margin-top: 15px;
            color: #d4af37;
            font-size: 14px;
            min-height: 20px;
        }
    </style>
</head>
<body>
    <div class="book-container">
        <!-- –ü–∞–Ω–µ–ª—å –∫–Ω–∏–≥ -->
        <div class="books-panel">
            <span style="color: #d4af37;">üìö –ú–æ–∏ –∫–Ω–∏–≥–∏:</span>
            <div class="books-list" id="booksList"></div>
        </div>

        <!-- –°—Ç—Ä–∞–Ω–∏—Ü–∞ -->
        <div class="page">
            <div class="page-header">
                <span class="book-title" id="currentBookTitle">–ö–Ω–∏–≥–∞ 1</span>
                <span>‚úé</span>
            </div>
            
            <div id="writingArea" 
                 class="writing-area" 
                 contenteditable="true"
                 placeholder="‚úçÔ∏è –ü–∏—à–∏ —á—Ç–æ —Ö–æ—á–µ—à—å...">
            </div>
        </div>

        <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
        <div class="action-buttons">
            <button class="action-btn" id="addBookBtn">‚ûï –ù–æ–≤–∞—è –∫–Ω–∏–≥–∞</button>
            <button class="action-btn" id="renameBookBtn">‚úèÔ∏è –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å</button>
            <button class="action-btn danger" id="deleteBookBtn">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å —ç—Ç—É –∫–Ω–∏–≥—É</button>
        </div>

        <div class="action-buttons">
            <button class="action-btn" id="shareBookBtn">üîó –ü–æ–¥–µ–ª–∏—Ç—å—Å—è —ç—Ç–æ–π –∫–Ω–∏–≥–æ–π</button>
            <button class="action-btn" id="shareAllBtn">üîó –ü–æ–¥–µ–ª–∏—Ç—å—Å—è –≤—Å–µ–º–∏</button>
        </div>

        <!-- –°—Ç–∞—Ç—É—Å -->
        <div class="status" id="status"></div>
        
        <!-- –ó–∞–∫–ª–∞–¥–∫–∞ -->
        <div class="bookmark"></div>
    </div>

    <script>
        class BookApp {
            constructor() {
                this.writingArea = document.getElementById('writingArea');
                this.booksList = document.getElementById('booksList');
                this.currentBookTitle = document.getElementById('currentBookTitle');
                this.status = document.getElementById('status');
                
                this.books = {};
                this.currentBookId = null;
                
                this.init();
            }

            init() {
                // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ URL
                const loaded = this.loadFromUrl();
                
                // –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–æ—Å—å –∏–∑ URL, –±–µ—Ä–µ–º –∏–∑ localStorage
                if (!loaded) {
                    this.loadFromStorage();
                }
                
                // –ï—Å–ª–∏ –≤—Å–µ –µ—â–µ –Ω–µ—Ç –∫–Ω–∏–≥, —Å–æ–∑–¥–∞–µ–º –æ–¥–Ω—É
                if (Object.keys(this.books).length === 0) {
                    this.createNewBook('–ú–æ—è –∫–Ω–∏–≥–∞');
                }
                
                this.renderBooksList();
                this.attachEvents();
            }

            // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑ URL (–¥–∞–Ω–Ω—ã–µ –≤ —Å—Å—ã–ª–∫–µ)
            loadFromUrl() {
                const urlParams = new URLSearchParams(window.location.search);
                const data = urlParams.get('data');
                
                if (data) {
                    try {
                        const jsonStr = decodeURIComponent(atob(data));
                        const loadedData = JSON.parse(jsonStr);
                        
                        if (loadedData.books) {
                            this.books = loadedData.books;
                            this.currentBookId = loadedData.currentBook || Object.keys(this.books)[0];
                            
                            this.saveToStorage();
                            
                            if (this.currentBookId && this.books[this.currentBookId]) {
                                this.writingArea.innerHTML = this.books[this.currentBookId].content;
                                this.currentBookTitle.textContent = this.books[this.currentBookId].title;
                            }
                            
                            this.showStatus('üìñ –ö–Ω–∏–≥–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ —Å—Å—ã–ª–∫–∏');
                            return true;
                        }
                    } catch (e) {
                        console.log('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ URL', e);
                    }
                }
                return false;
            }

            // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ localStorage
            saveToStorage() {
                localStorage.setItem('myBooks', JSON.stringify(this.books));
                localStorage.setItem('lastBook', this.currentBookId);
            }

            // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑ localStorage
            loadFromStorage() {
                const saved = localStorage.getItem('myBooks');
                if (saved) {
                    try {
                        this.books = JSON.parse(saved);
                        this.currentBookId = localStorage.getItem('lastBook');
                        
                        if (!this.currentBookId || !this.books[this.currentBookId]) {
                            this.currentBookId = Object.keys(this.books)[0];
                        }
                        
                        if (this.currentBookId && this.books[this.currentBookId]) {
                            this.writingArea.innerHTML = this.books[this.currentBookId].content;
                            this.currentBookTitle.textContent = this.books[this.currentBookId].title;
                        }
                    } catch (e) {}
                }
            }

            // –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∫–Ω–∏–≥—É
            createNewBook(title) {
                const id = 'book_' + Date.now() + '_' + Math.random().toString(36).substring(2, 6);
                this.books[id] = {
                    title: title,
                    content: ''
                };
                this.currentBookId = id;
                this.writingArea.innerHTML = '';
                this.currentBookTitle.textContent = title;
                this.saveToStorage();
                this.renderBooksList();
                this.showStatus('‚úÖ –ù–æ–≤–∞—è –∫–Ω–∏–≥–∞ —Å–æ–∑–¥–∞–Ω–∞');
            }

            // –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –∫–Ω–∏–≥—É
            switchBook(id) {
                if (this.currentBookId) {
                    this.books[this.currentBookId].content = this.writingArea.innerHTML;
                }
                
                this.currentBookId = id;
                this.writingArea.innerHTML = this.books[id].content;
                this.currentBookTitle.textContent = this.books[id].title;
                this.saveToStorage();
                this.renderBooksList();
            }

            // –£–¥–∞–ª–∏—Ç—å –∫–Ω–∏–≥—É
            deleteCurrentBook() {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –ø–æ—Å–ª–µ–¥–Ω—è—è –ª–∏ —ç—Ç–æ –∫–Ω–∏–≥–∞
                if (Object.keys(this.books).length <= 1) {
                    this.showStatus('‚ùå –ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω—é—é –∫–Ω–∏–≥—É');
                    return;
                }
                
                if (confirm(`–£–¥–∞–ª–∏—Ç—å –∫–Ω–∏–≥—É "${this.books[this.currentBookId].title}"?`)) {
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º ID —É–¥–∞–ª—è–µ–º–æ–π –∫–Ω–∏–≥–∏
                    const deletedId = this.currentBookId;
                    
                    // –ù–∞—Ö–æ–¥–∏–º –¥—Ä—É–≥—É—é –∫–Ω–∏–≥—É –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è
                    const bookIds = Object.keys(this.books);
                    const currentIndex = bookIds.indexOf(deletedId);
                    const nextIndex = currentIndex > 0 ? currentIndex - 1 : 1;
                    
                    // –£–¥–∞–ª—è–µ–º –∫–Ω–∏–≥—É
                    delete this.books[deletedId];
                    
                    // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –¥—Ä—É–≥—É—é –∫–Ω–∏–≥—É
                    this.currentBookId = bookIds[nextIndex];
                    
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–æ–≤—É—é –∫–Ω–∏–≥—É
                    this.writingArea.innerHTML = this.books[this.currentBookId].content;
                    this.currentBookTitle.textContent = this.books[this.currentBookId].title;
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
                    this.saveToStorage();
                    this.renderBooksList();
                    
                    this.showStatus('üóëÔ∏è –ö–Ω–∏–≥–∞ —É–¥–∞–ª–µ–Ω–∞');
                }
            }

            // –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å –∫–Ω–∏–≥—É
            renameCurrentBook() {
                const newTitle = prompt('–ù–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–Ω–∏–≥–∏:', this.books[this.currentBookId].title);
                if (newTitle && newTitle.trim()) {
                    this.books[this.currentBookId].title = newTitle.trim();
                    this.currentBookTitle.textContent = newTitle.trim();
                    this.saveToStorage();
                    this.renderBooksList();
                    this.showStatus('‚úèÔ∏è –ö–Ω–∏–≥–∞ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∞');
                }
            }

            // –ü–æ–¥–µ–ª–∏—Ç—å—Å—è –æ–¥–Ω–æ–π –∫–Ω–∏–≥–æ–π
            shareCurrentBook() {
                this.books[this.currentBookId].content = this.writingArea.innerHTML;
                
                const shareData = {
                    books: {
                        [this.currentBookId]: this.books[this.currentBookId]
                    },
                    currentBook: this.currentBookId
                };
                
                this.createShareLink(shareData, '–æ–¥–Ω–æ–π –∫–Ω–∏–≥–æ–π');
            }

            // –ü–æ–¥–µ–ª–∏—Ç—å—Å—è –≤—Å–µ–º–∏ –∫–Ω–∏–≥–∞–º–∏
            shareAllBooks() {
                this.books[this.currentBookId].content = this.writingArea.innerHTML;
                
                const shareData = {
                    books: this.books,
                    currentBook: this.currentBookId
                };
                
                this.createShareLink(shareData, '–≤—Å–µ–º–∏ –∫–Ω–∏–≥–∞–º–∏');
            }

            // –°–æ–∑–¥–∞—Ç—å —Å—Å—ã–ª–∫—É
            createShareLink(data, type) {
                const jsonStr = JSON.stringify(data);
                const encoded = btoa(encodeURIComponent(jsonStr));
                const url = window.location.href.split('?')[0] + '?data=' + encoded;
                
                navigator.clipboard.writeText(url).then(() => {
                    this.showStatus(`‚úÖ –°—Å—ã–ª–∫–∞ —Å ${type} —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!`);
                }).catch(() => {
                    prompt('–°–∫–æ–ø–∏—Ä—É–π —Å—Å—ã–ª–∫—É:', url);
                });
            }

            // –û—Ç—Ä–∏—Å–æ–≤–∞—Ç—å —Å–ø–∏—Å–æ–∫ –∫–Ω–∏–≥
            renderBooksList() {
                let html = '';
                
                for (let [id, book] of Object.entries(this.books)) {
                    html += `
                        <div class="book-tab ${id === this.currentBookId ? 'active' : ''}">
                            <span onclick="app.switchBook('${id}')">${book.title}</span>
                            <span class="delete-book" onclick="app.deleteBook('${id}', event)">‚úï</span>
                        </div>
                    `;
                }
                
                this.booksList.innerHTML = html;
            }

            // –£–¥–∞–ª–∏—Ç—å –∫–Ω–∏–≥—É –ø–æ –∫–ª–∏–∫—É –Ω–∞ –∫—Ä–µ—Å—Ç–∏–∫
            deleteBook(id, event) {
                event.stopPropagation();
                
                if (Object.keys(this.books).length <= 1) {
                    this.showStatus('‚ùå –ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω—é—é –∫–Ω–∏–≥—É');
                    return;
                }
                
                if (confirm(`–£–¥–∞–ª–∏—Ç—å –∫–Ω–∏–≥—É "${this.books[id].title}"?`)) {
                    // –ï—Å–ª–∏ —É–¥–∞–ª—è–µ–º —Ç–µ–∫—É—â—É—é –∫–Ω–∏–≥—É
                    if (id === this.currentBookId) {
                        const bookIds = Object.keys(this.books);
                        const currentIndex = bookIds.indexOf(id);
                        const nextIndex = currentIndex > 0 ? currentIndex - 1 : 1;
                        
                        delete this.books[id];
                        this.currentBookId = bookIds[nextIndex];
                        
                        this.writingArea.innerHTML = this.books[this.currentBookId].content;
                        this.currentBookTitle.textContent = this.books[this.currentBookId].title;
                    } else {
                        delete this.books[id];
                    }
                    
                    this.saveToStorage();
                    this.renderBooksList();
                    this.showStatus('üóëÔ∏è –ö–Ω–∏–≥–∞ —É–¥–∞–ª–µ–Ω–∞');
                }
            }

            // –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç—É—Å
            showStatus(message) {
                this.status.textContent = message;
                setTimeout(() => {
                    this.status.textContent = '';
                }, 2000);
            }

            attachEvents() {
                // –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
                this.writingArea.addEventListener('input', () => {
                    this.books[this.currentBookId].content = this.writingArea.innerHTML;
                    this.saveToStorage();
                });

                // –í—Å—Ç–∞–≤–∫–∞ —Ç–µ–∫—Å—Ç–∞
                this.writingArea.addEventListener('paste', (e) => {
                    e.preventDefault();
                    const text = e.clipboardData.getData('text/plain');
                    
                    const selection = window.getSelection();
                    const range = selection.getRangeAt(0);
                    const textNode = document.createTextNode(text);
                    range.deleteContents();
                    range.insertNode(textNode);
                    range.setStartAfter(textNode);
                    range.setEndAfter(textNode);
                    selection.removeAllRanges();
                    selection.addRange(range);
                    
                    this.books[this.currentBookId].content = this.writingArea.innerHTML;
                    this.saveToStorage();
                });

                // –ö–Ω–æ–ø–∫–∏
                document.getElementById('addBookBtn').addEventListener('click', () => {
                    const title = prompt('–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–π –∫–Ω–∏–≥–∏:', '–ù–æ–≤–∞—è –∫–Ω–∏–≥–∞');
                    if (title) this.createNewBook(title);
                });

                document.getElementById('renameBookBtn').addEventListener('click', () => {
                    this.renameCurrentBook();
                });

                document.getElementById('deleteBookBtn').addEventListener('click', () => {
                    this.deleteCurrentBook();
                });

                document.getElementById('shareBookBtn').addEventListener('click', () => {
                    this.shareCurrentBook();
                });

                document.getElementById('shareAllBtn').addEventListener('click', () => {
                    this.shareAllBooks();
                });
            }
        }

        // –ó–∞–ø—É—Å–∫–∞–µ–º
        document.addEventListener('DOMContentLoaded', () => {
            window.app = new BookApp();
        });
    </script>
</body>
</html>
